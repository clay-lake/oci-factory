#!/usr/bin/env python3

import report_malware_scan

INFECTED_SCAN_OUTPUT = """LibClamAV Warning: **************************************************
LibClamAV Warning: ***  The virus database is older than 7 days!  ***
LibClamAV Warning: ***   Please update it as soon as possible.    ***
LibClamAV Warning: **************************************************
/scandir/test_file: OK
/scandir/eicar.com: Win.Test.EICAR_HDB-1 FOUND
/scandir/eicar.com!(0): Win.Test.EICAR_HDB-1 FOUND

----------- SCAN SUMMARY -----------
Known viruses: 8696388
Engine version: 1.0.6
Scanned directories: 1
Scanned files: 2
Infected files: 1
Data scanned: 0.00 MB
Data read: 0.00 MB (ratio 0.00:1)
Time: 17.860 sec (0 m 17 s)
Start Date: 2024:08:19 09:32:28
End Date:   2024:08:19 09:32:46

"""

PARSED_INFECTED_SCAN =(
    {'Known viruses': '8696388', 'Engine version': '1.0.6', 'Scanned directories': '1', 'Scanned files': '2', 'Infected files': '1', 'Data scanned': '0.00 MB', 'Data read': '0.00 MB (ratio 0.00:1)', 'Time': '17.860 sec (0 m 17 s)', 'Start Date': '2024:08:19 09:32:28', 'End Date': '  2024:08:19 09:32:46'},
    {'/scandir/test_file': 'OK', '/scandir/eicar.com': 'Win.Test.EICAR_HDB-1 FOUND', '/scandir/eicar.com!(0)': 'Win.Test.EICAR_HDB-1 FOUND'},
    {'/scandir/eicar.com': 'Win.Test.EICAR_HDB-1 FOUND', '/scandir/eicar.com!(0)': 'Win.Test.EICAR_HDB-1 FOUND'}
)

CLEAN_SCAN_OUTPUT = """LibClamAV Warning: **************************************************
LibClamAV Warning: ***  The virus database is older than 7 days!  ***
LibClamAV Warning: ***   Please update it as soon as possible.    ***
LibClamAV Warning: **************************************************
/scandir/test_file: OK

----------- SCAN SUMMARY -----------
Known viruses: 8696388
Engine version: 1.0.6
Scanned directories: 1
Scanned files: 1
Infected files: 0
Data scanned: 0.00 MB
Data read: 0.00 MB (ratio 0.00:1)
Time: 17.928 sec (0 m 17 s)
Start Date: 2024:08:19 09:41:38
End Date:   2024:08:19 09:41:55

"""
PARSED_CLEAN_SCAN =(
    {'Known viruses': '8696388', 'Engine version': '1.0.6', 'Scanned directories': '1', 'Scanned files': '1', 'Infected files': '0', 'Data scanned': '0.00 MB', 'Data read': '0.00 MB (ratio 0.00:1)', 'Time': '17.928 sec (0 m 17 s)', 'Start Date': '2024:08:19 09:41:38', 'End Date': '  2024:08:19 09:41:55'},
    {'/scandir/test_file': 'OK'},
    {}
)

def test_clamavscan_dataclass():
    result = report_malware_scan.ClamAVScan(*PARSED_INFECTED_SCAN)
    assert result.summary == PARSED_INFECTED_SCAN[0], "ClamAVScan summary not passed correctly"
    assert result.scanned_files == PARSED_INFECTED_SCAN[1], "ClamAVScan scanned_files not passed correctly"
    assert result.infected_files == PARSED_INFECTED_SCAN[2], "ClamAVScan infected_files not passed correctly"

def test_parse_clamav_log_with_clean_scan():

    result = report_malware_scan.parse_clamav_log(CLEAN_SCAN_OUTPUT)
    expected_result = report_malware_scan.ClamAVScan(*PARSED_CLEAN_SCAN)

    assert result == expected_result, "Clean scan parsed incorrectly"

def test_parse_clamav_log_with_infected_scan():

    result = report_malware_scan.parse_clamav_log(INFECTED_SCAN_OUTPUT)
    expected_result = report_malware_scan.ClamAVScan(*PARSED_INFECTED_SCAN)

    assert result == expected_result, "Infected scan parsed incorrectly"


